# postgres12-cluster

## Описание

[postgresql](https://www.postgresql.org/) - реляционная база данных
[repmgr](http://www.repmgr.org/) - набор утилит для управления репликацией postgresql и мониторинга базы с функцией фейловера
[keepalived](http://www.keepalived.org) - монитор сервисов с функцией переключения ip
[pg_repack](https://github.com/reorg/pg_repack) - утилита для высвобождения места диска после удаления данных без блокировки таблиц, альтернатива VACUUM FULL

postgres-cluster - реализует отказоустойчивый кластер PostgreSQL12, управляемый менеджером репликаций repmgr.

За основу взят открытый проект [PostDock](https://github.com/paunin/PostDock/).

Слежение за мастером постгреса и поддержание на нем плавающего внутреннего ip осуществляется при помощи keepalived, проверка осуществляется скриптом [/usr/local/bin/db_check_master.sh](db_check_master.sh).

## privileged mode

Контейнер необходимо запускать в privileged режиме и с --net=host, для возможности назначения динамического ip на сетевой интерфейс.

## pg_repack

Для его использования в postgresql.conf в базе должно быть указано shared_preload_libraries = 'pg_repack'. Либо можно в конфиг контейнера добавить энву CONFIGS=shared_preload_libraries:'pg_repack'. Для возможности чистить таблицы в базе - нужно к ней подключиться и выполнить команду CREATE EXTENSION pg_repack;

Возможные опции запуска pg_repack:

| Опция         | Описание                                                         |
|:--------------|:-----------------------------------------------------------------|
| --dry-run     | Имитация очистки без реальных действий                           |
| -d basename   | Использовать на конкретной базе                                  |
| -t tablename  | Использовать на конкретной таблице, без -d не работает           |
| -j threadsnum | Многопоточная чистка, кол-во потоков не указывать больше чем cpu |

Пример использования: `gosu $POSTGRES_USER pg_repack -d processoptima_zabota -t notification_roles -j 4` либо `make_repack.sh`, для репака всех баз.

## Переменные окружения

### repmgr

| Имя переменной            | Описание                                                    |
|:--------------------------|:------------------------------------------------------------|
| NODE_ID                   | Число, должно быть уникальным у разных нод                  |
| NODE_NAME                 | Имя текущей ноды, должно быть уникальным                    |
| CLUSTER_NODE_NETWORK_NAME | Сетевое имя ноды, если не задано то возьмет hostname        |
| PARTNER_NODES             | Список всех нод через запятую                               |
| REPLICATION_PRIMARY_HOST  | Имя ноды с текущим мастером, нужно при запуске              |
| CLUSTER_NAME              | Имя кластера, по дефолтуpg_cluster                          |
| REPLICATION_DB            | База для repmgr, по дефолту replication_db                  |
| REPLICATION_USER          | Имя пользователя для repmgr, по дефолту replication_user    |
| REPLICATION_PASSWORD      | Пароль пользователя для repmgr, по дефолту replication_pass |
| REPLICATION_PRIMARY_PORT  | Порт, на котором поднят postgresql, по дефолту 5432         |

### postgresql

| Имя переменной        | Описание                                                                                           |
|:----------------------|:---------------------------------------------------------------------------------------------------|
| POSTGRES_USER         | Имя суперпользователя. Если отличается от postgres то создает ему базу                             |
| POSTGRES_PASSWORD     | Пароль суперпользователя                                                                           |
| POSTGRES_DB           | Имя создаваемой нестандартному пользователю базы                                                   |
| USE_REPLICATION_SLOTS | Использование replication slots для гарантии доставки WAL до реплик, дефолт 1                      |
| STANDALONE            | При отличном от false значении позволит снимать бэкапы с мастера и не будет использовать keepalive |

| Имя раздела              | Описание                         |
|:-------------------------|:---------------------------------|
| /var/lib/postgresql/data | Используется для размещения базы |

### keepalive

| Имя переменной       | Описание                                                   |
|:---------------------|:-----------------------------------------------------------|
| OTHER_NODE_NAME      | Сетевое имя второй ноды, нужно для связи по протоколу vrrp |
| KEEPALIVED_INTERFACE | Интерфейс для плавающего ip, по дефолту eth0               |
| FLOAT_IP             | Адрес, назначаемый мастеру кластера                        |

### backup

| Имя переменной    | Описание                                                                |
|:------------------|:------------------------------------------------------------------------|
| OPENSSL_PASSWORD  | Пароль для шифрования\расшифровки бэкапов, алгоритм aes-256-cbc с солью |
| BACKUP_HOST       | Сервер для бэкапов                                                      |
| BACKUP_USERNAME   | Имя пользователя для подключения к серверу                              |
| BACKUP_PATH       | Путь, по которому складывать бэкапы                                     |
| APP_SLACK_WEBHOOK | Вебхук для уведомлений в Slack                                          |
| SLACK_CHANNEL     | Канал для уведомлений в слаке                                           |

| Имя раздела | Описание                                          |
|:------------|:--------------------------------------------------|
| /dbbackup   | временная папка для создания\скачивания бэкапов   |
| /backupkeys | Папка с ssh-ключами для доступа к серверу бэкапов |

## Бэкапы

Ниже представлен ряд утилит для создания, восстановления и просмотра имеющихся бэкапов.

### init_backup.sh

Скрипт для создания бэкапа текущих ролей и баз, в качестве аргумента можно передать имя базы для создания резервной копии.
Использование: `init_backup.sh <db_name>`, например `init_backup.sh` или `init_backup.sh database1`.

Создает дампы выбранной/всех баз в /dbbackup/текущая-дата-и-время/ с именами вида имябазы.sql и дамп всех ролей с именем roles.sql. После этого созданные файлы сжимаются в tar.gz архив и шифруются openssl'ем, используя алгоритм aes-256-cbc с "солью" и пароль из переменной OPENSSL_PASSWORD. После этого зашифрованный архив отправляется на BACKUP_HOST в папку BACKUP_PATH пари помощи scp. Аутентификация происходит с именем пользователя BACKUP_USERNAME и ключом /backupkeys/id_rsa.

Все сообщения об ошибках создания/отправки бэкапа отправляются в слак, как и сообщения об удачном бэкапе со списком забэкапленных баз.

### list_backup.sh

Скрипт для просмотра имеющихся бэкапов, выполняет на BACKUP_HOST в папке BACKUP_PATH команду ls -lh

### restore_backup.sh

Скрипт для восстановления бэкапов баз и ролей. Использование: `restore_backup.sh "имя бэкапа" "список файлов баз через пробел" --tmp`. Список для восстановления не обязателен, если не указывать то будут восстановлены все роли с GRANT'ами и все базы в бэкапе. Например `restore_backup.sh backup-2019-10-18-11-14` или `restore_backup.sh backup-2019-10-18-11-14 "roles.sql database1.sql database2.sql"`. Аргумент `--tmp` также не обязателен и применим только с указанием одного дампа. Восстанавливает дамп во временную базу tmp_restore_db. Все сообщения об ошибках скачивания/распаковки/восстановлении бэкапа отправляются в слак, как и сообщения об удачном восстановлении со списком восстановленных баз.
