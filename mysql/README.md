# mysql

## Описание

[mysql](https://www.mysql.com/) - реляционная база данных


Контейнер mysql - реализует контейнер со стабильной версией 5.7 и возможностью создания и развертывания бэкапов.

За основу взят оффициалньый образ mysql.
## Рабочие сервисы/процессы

Утилиты:

- [/usr/local/bin/list_backup.sh](list_backup.sh) - ходит по ssh на сервер с бэкапами и делает ls -lh папки бэкапов.
- [/usr/local/bin/init_backup.sh](init_backup.sh) - создает бэкап всех или выбранной базы, сжимает, шифрует и отправляет на сервер с бэкапами.
- [/usr/local/bin/restore_backup.sh](restore_backup.sh) - забирает с сервера с бэкапами выбранный бэкап и либо восстанавливает из бэкапа все базы, либо только выбранные.

Подробнее о данных утилитах в соответствующих разделах.

## Переменные окружения

### mysql

| Имя переменной      | Описание                                                     |
|:--------------------|:-------------------------------------------------------------|
| MYSQL_ROOT_PASSWORD | Пароль суперпользователя базы                                |
| MYSQL_USER          | Логин создаваемого при инициализации контейнера пользователя |
| MYSQL_PASSWORD      | И его пароль                                                 |

### backup

| Имя переменной    | Описание                                                                |
|:------------------|:------------------------------------------------------------------------|
| OPENSSL_PASSWORD  | Пароль для шифрования\расшифровки бэкапов, алгоритм aes-256-cbc с солью |
| BACKUP_HOST       | Сервер для бэкапов                                                      |
| BACKUP_USERNAME   | Имя пользователя для подключения к серверу                              |
| BACKUP_PATH       | Путь, по которому складывать бэкапы                                     |
| APP_SLACK_WEBHOOK | Вебхук для уведомлений в Slack                                          |
| SLACK_CHANNEL     | Канал для уведомлений в слаке                                           |

| Имя раздела | Описание                                          |
|:------------|:--------------------------------------------------|
| /dbbackup   | временная папка для создания\скачивания бэкапов   |
| /backupkeys | Папка с ssh-ключами для доступа к серверу бэкапов |

## Инициализация

Процесс инициализации базы данных при первом запуске.

## Бэкапы

Ниже представлен ряд утилит для создания, восстановления и просмотра имеющихся бэкапов.

### init_backup.sh

Скрипт для создания бэкапа текущих ролей и баз, в качестве аргумента можно передать имя базы для создания резервной копии.
Использование: `init_backup.sh <db_name>`, например `init_backup.sh` или `init_backup.sh database1`.

Создает дампы выбранной/всех баз в /dbbackup/текущая-дата-и-время/ с именами вида имябазы.sql. После этого созданные файлы сжимаются в tar.gz архив и шифруются openssl'ем, используя алгоритм aes-256-cbc с "солью" и пароль из переменной OPENSSL_PASSWORD. После этого зашифрованный архив отправляется на BACKUP_HOST в папку BACKUP_PATH пари помощи scp. Аутентификация происходит с именем пользователя BACKUP_USERNAME и ключом /backupkeys/id_rsa.

Все сообщения об ошибках создания/отправки бэкапа отправляются в слак, как и сообщения об удачном бэкапе со списком забэкапленных баз.

### list_backup.sh

Скрипт для просмотра имеющихся бэкапов, выполняет на BACKUP_HOST в папке BACKUP_PATH команду ls -lh

### restore_backup.sh

Скрипт для восстановления бэкапов баз и ролей. Использование: `restore_backup.sh "имя бэкапа" "список файлов баз через пробел"`. Список для восстановления не обязателен, если не указывать то будут восстановлены все базы в бэкапе. Например `restore_backup.sh backup-2019-10-18-11-14` или `restore_backup.sh backup-2019-10-18-11-14 "roles.sql database1.sql database2.sql"`. Все сообщения об ошибках скачивания/распаковки/восстановлении бэкапа отправляются в слак, как и сообщения об удачном восстановлении со списком восстановленных баз.
